<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cooped - Redirecting...</title>
  <style>
    body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .container { text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    h2 { color: #333; margin: 0; }
    p { color: #999; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Redirecting to Cooped...</h2>
    <p>Please wait.</p>
  </div>

  <script>
    // Get all params from hash and search
    const hash = window.location.hash.substring(1);
    const search = window.location.search.substring(1);
    const hashParams = new URLSearchParams(hash);
    const searchParams = new URLSearchParams(search);
    const extensionId = searchParams.get('ext');

    // Check for email verification (has access_token)
    const accessToken = hashParams.get('access_token') || searchParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token') || searchParams.get('refresh_token');
    const type = hashParams.get('type') || searchParams.get('type');

    // Check for OAuth callback (has code)
    const code = hashParams.get('code') || searchParams.get('code');

    console.log('Redirect params - AccessToken:', !!accessToken, 'Code:', !!code, 'Ext ID:', extensionId);

    if (!extensionId) {
      document.querySelector('p').textContent = 'Error: Missing extension ID. Please try again.';
      console.error('Missing extension ID');
    } else if (accessToken) {
      // Email verification flow
      const extensionUrl = `chrome-extension://${extensionId}/src/popup/auth-callback.html#access_token=${accessToken}&refresh_token=${refreshToken || ''}&type=${type || ''}`;
      console.log('Redirecting to extension with tokens...');
      window.location.href = extensionUrl;
    } else if (code) {
      // OAuth callback flow - send code to extension
      console.log('OAuth callback received, sending code to extension...');
      const extensionUrl = `chrome-extension://${extensionId}/src/popup/auth-callback.html?code=${code}`;
      
      // Also try to send message to extension in case it's listening
      if (window.opener) {
        window.opener.postMessage({
          type: 'OAUTH_CALLBACK',
          code: code
        }, '*');
      }
      
      window.location.href = extensionUrl;
    } else {
      document.querySelector('p').textContent = 'Error: Missing authentication data. Please try signing up again.';
      console.error('Missing required parameters:', { accessToken: !!accessToken, code: !!code, extensionId });
    }
  </script>
</body>
</html>
